name: Build container for production

on:
  push:
    branches:
    - master
  schedule:
  - cron: 30 1 * * 1

jobs:
  build:
    env:
      REPO_NAME: $(echo ${{ github.repository }} | awk -F"/" '{print $2}')
      SHA8: $(echo ${GITHUB_SHA} | cut -c1-8)
      DOCKER_TAG: docker.pkg.github.com/${{ github.repository }}/$(echo ${{ github.repository }} | awk -F"/" '{print $2}')

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Docker login
      run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login docker.pkg.github.com --username automation@linkorb.com --password-stdin
    - name: Build the Docker image
      run: docker build . --tag ${DOCKER_TAG}:latest --file Dockerfile
    - name: Docker push with latest tag
      run: docker push ${DOCKER_TAG}:latest
    - name: Docker retag new image with commit hash
      run: docker image tag ${DOCKER_TAG}:latest ${DOCKER_TAG}:${{ env.SHA8 }}
    - name: Docker push with commit hash tag
      run: docker push ${DOCKER_TAG}:${{ env.SHA8 }}
